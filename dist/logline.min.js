!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Logline=e()}(this,function(){"use strict";function t(t){throw new Error("Logline: "+t)}function e(t){var o,r={};if("object"!==(void 0===t?"undefined":n(t)))return t;for(o in t)t.hasOwnProperty(o)&&"function"!=typeof t[o]&&(r[o]=e(t[o]));return r}function o(t,e){function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(){function e(t){this._namespace=t}return e.prototype._record=function(e,o,n){t("method _record is not implemented.")},e.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._record.apply(this,["info"].concat(t))},e.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._record.apply(this,["warn"].concat(t))},e.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._record.apply(this,["error"].concat(t))},e.prototype.critical=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._record.apply(this,["critical"].concat(t))},e.init=function(t){},e.transTimeFormat=function(t,e){if(!t||/^\d{13}$/.test(t))return+t;if(e&&!/^\d{13}$/.test(e))throw new TypeError("relative time should be standard unix timestamp");return(e||Date.now())-24*t.replace(/d$/,"")*3600*1e3},e.get=function(e,o,n){t("method get is not implemented.")},e.keep=function(e){t("method keep is not implemented.")},e.clean=function(){t("method clean is not implemented.")},Object.defineProperty(e,"STATUS",{get:function(){return{INITING:1,INITED:2,FAILED:4}},enumerable:!0,configurable:!0}),e}(),a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])},i=function(){function t(){this._pool=[]}return t.prototype.push=function(t,e){t.context=e,this._pool.push(t)},t.prototype.consume=function(){for(var t;t=this._pool.shift();)t.call(t.context)},t}(),c=function(n){function a(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.apply(this,t)||this}return o(a,n),a.prototype._record=function(o,n,i){var c=this;if(a.status!==r.STATUS.INITED)return a._pool.push(function(){return c._record(o,n,i)}),void(a.status!==r.STATUS.INITING&&a.init());var s=a.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite");s.onerror=function(e){return t(e.target.error)},s.objectStore("logs").add({time:Date.now(),level:o,namespace:this._namespace,descriptor:n,data:e(i)}).onerror=function(e){a.status=r.STATUS.FAILED,t(e.target.error)}},a.init=function(e){if(a.support||t("your platform does not support indexeddb protocol."),a.status)return!1;a._pool=a._pool||new i,a._database=e||"logline",a.status=n.STATUS.INITING,a.request=window.indexedDB.open(a._database),a.request.onerror=function(e){return t("protocol indexeddb is prevented.")},a.request.onsuccess=function(e){a.db=e.target.result,a.status=n.STATUS.INITED,a._pool.consume(),a.db.onerror=function(e){return t(e.target.error)}},a.request.onupgradeneeded=function(t){var e=t.target.result,o=e.createObjectStore("logs",{autoIncrement:!0});o.createIndex("namespace","namespace",{unique:!1}),o.createIndex("level","level",{unique:!1}),o.createIndex("descriptor","descriptor",{unique:!1}),o.createIndex("data","data",{unique:!1})}},a.get=function(t,e,o){if(a.status!==n.STATUS.INITED)return a._pool.push(function(){return a.get(t,e,o)});t=r.transTimeFormat(t),e=r.transTimeFormat(e);var i=a._getTransactionStore(IDBTransaction.READ_ONLY);if(i.getAll){var c,s=[];i.getAll().onsuccess=function(n){c=n.target.result;for(var r=0;r<c.length;r++)t&&c[r].time<t||e&&c[r].time>e||s.push(c[r]);o(s)}}else{var u=i.openCursor(),l=[];u.onsuccess=function(n){var r=n.target.result;if(r){if(t&&r.value.time<t||e&&r.value.time>e)return r.continue();l.push({time:r.value.time,level:r.value.level,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r.continue()}else o(l)}}},a.keep=function(e){if(a.status!==n.STATUS.INITED)return a._pool.push(function(){return a.keep(e)});var o=a._getTransactionStore(IDBTransaction.READ_WRITE);if(e){var r=Date.now()-24*(e||2)*3600*1e3,i=o.openCursor();i.onsuccess=function(t){var e=t.target.result;e&&e.value.time<r&&(o.delete(e.primaryKey),e.continue())},i.onerror=function(o){return t("unable to locate logs earlier than "+e+"d.")}}else var i=o.clear().onerror=function(e){return t(e.target.error)}},a.clean=function(){if(a.status!==n.STATUS.INITED)return a._pool.push(function(){return a.clean()});a.db.close();var e=window.indexedDB.deleteDatabase(a._database);e.onerror=function(e){return t(e.target.error)},e.onsuccess=function(t){delete a.status,delete a.db}},a._getTransactionStore=function(e){if(a.db){var o=a.db.transaction(["logs"],e||IDBTransaction.READ_WRITE);return o.onerror=function(e){return t(e.target.error)},o.objectStore("logs")}t("log database is not created or connections are closed, considering init it.")},Object.defineProperty(a,"support",{get:function(){var t=!!("indexedDB"in window&&"IDBTransaction"in window&&"IDBKeyRange"in window);return t&&(IDBTransaction.READ_WRITE=IDBTransaction.READ_WRITE||"readwrite",IDBTransaction.READ_ONLY="readonly"),t},enumerable:!0,configurable:!0}),a}(r),s=function(e){function n(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return e.apply(this,t)||this}return o(n,e),n.prototype._record=function(e,o,r){var a=window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[];a.push([Date.now(),this._namespace,e,o,r]);try{window.localStorage.setItem(n._database,JSON.stringify(a))}catch(e){t("error inserting record")}},n.init=function(o){n.support||t("your platform does not support localstorage protocol."),n._database=o||"logline",window.localStorage.getItem(n._database)||window.localStorage.setItem(n._database,JSON.stringify([])),n.status=e.STATUS.INITED},n.get=function(t,e,o){var a,i=JSON.parse(window.localStorage.getItem(n._database));for(t=r.transTimeFormat(t),e=r.transTimeFormat(e),a=0;a<i.length;a++)t&&i[a][0]<t||e&&i[a][0]>e||(i[a]={time:i[a][0],namespace:i[a][1],level:i[a][2],descriptor:i[a][3],data:i[a][4]});o(i)},n.keep=function(t){var e=t?(window.localStorage.getItem(n._database)?JSON.parse(window.localStorage.getItem(n._database)):[]).filter(function(e){return e.time>=Date.now()-24*(t||2)*3600*1e3}):[];window.localStorage.setItem(n._database,JSON.stringify(e))},n.clean=function(){delete n.status,window.localStorage.removeItem(n._database)},Object.defineProperty(n,"support",{get:function(){return"localStorage"in window},enumerable:!0,configurable:!0}),n}(r),u=function(e){function n(){for(var t=[],o=0;o<arguments.length;o++)t[o]=arguments[o];return e.apply(this,t)||this}return o(n,e),n.prototype._record=function(e,o,a){var i=this;if(n.status!==r.STATUS.INITED)return n._pool.push(function(){return i._record(e,o,a)}),void(n.status!==r.STATUS.INITING&&n.init());try{n._db.transaction(function(t){t.executeSql("INSERT INTO logs (time, namespace, level, descriptor, data) VALUES(?, ?, ?, ? ,?)",[Date.now(),i._namespace,e,o,void 0===a||""===a?"":JSON.stringify(a)||""],function(){},function(t,e){throw e.message})})}catch(e){t("error inserting record")}},n.init=function(o){if(n.support||t(new Error("your platform does not support websql protocol.")),n.status)return!1;n._pool=n._pool||new i,n._database=o||"logline",n.status=e.STATUS.INITING;try{n._db=window.openDatabase(n._database,"1.0","cats loves logs",5085593.6),n._db.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS logs (time, namespace, level, descriptor, data)",[],function(){n.status=e.STATUS.INITED,n._pool.consume()},function(){n.status=e.STATUS.FAILED})})}catch(e){t("unable to init log database.")}},n.get=function(o,a,i){if(n.status!==e.STATUS.INITED)return n._pool.push(function(){return n.get(o,a,i)});o=r.transTimeFormat(o),a=r.transTimeFormat(a);try{n._db.transaction(function(t){t.executeSql("SELECT * FROM logs ORDER BY time DESC",[],function(t,e){for(var n,r,c=[],s=e.rows.length;--s>=0;)if(r=e.rows.item(s),!(o&&r.time<o||a&&r.time>a)){n=JSON.parse(JSON.stringify(r));try{n.data=JSON.parse(n.data)}catch(t){}c.push(n)}i(c)},function(t,e){throw e.message})})}catch(e){t("unable to collect logs from database.")}},n.keep=function(o){if(n.status!==e.STATUS.INITED)return n._pool.push(function(){return n.keep(o)});try{n._db.transaction(function(t){o?t.executeSql("DELETE FROM logs WHERE time < ?",[Date.now()-24*(o||2)*3600*1e3],function(){},function(t,e){throw e.message}):t.executeSql("DELETE FROM logs",[],function(){},function(t,e){throw e.message})})}catch(e){t("unable to clean logs from database.")}},n.clean=function(){if(n.status!==e.STATUS.INITED)return void n._pool.push(function(){return n.clean()});try{n._db.transaction(function(t){t.executeSql("DROP TABLE logs",[],function(){delete n.status},function(t,e){throw e.message})})}catch(e){t("unable to clean log database.")}},Object.defineProperty(n,"support",{get:function(){return"openDatabase"in window},enumerable:!0,configurable:!0}),n}(r),l=function(){function e(t){return this instanceof e?(e._checkProtocol(),new e._protocol(t)):new e(t)}return e._initProtocol=function(t){e._protocol=t,e._protocol.init(e._database||"logline")},e._checkProtocol=function(){if(!e._protocol){for(var t=Object.keys(e.PROTOCOL),o=void 0;o=e.PROTOCOL[t.shift()];)if(o.support)return void e._initProtocol(o);throw new Error(t.join(", ").toLowerCase()+" protocols are not supported on this platform")}},e.get=function(t,o,n){switch(e._checkProtocol(),arguments.length){case 1:n=t,t=void 0;break;case 2:n=o,o=void 0}e._protocol.get(t,o,n)},e.all=function(t){e.get(t)},e.keep=function(t){return e._checkProtocol(),e._protocol.keep(t),this},e.clean=function(){return e._checkProtocol(),e._protocol.clean(),this},e.using=function(o,n){return-1===[c,s,u].indexOf(o)&&t("specialfied protocol "+(o?o+" ":"")+"is not available"),e._protocol?this:(e.database(n||e._database),e._initProtocol(o),this)},e.database=function(t){e._database=t},e}();return l.PROTOCOL={INDEXEDDB:c,LOCALSTORAGE:s,WEBSQL:u},l.INTERFACE=Object.freeze(r),l});
//# sourceMappingURL=logline.min.js.map
